<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no"
  />
  <title>Казино-генератор кейсов</title>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#0b0e14;
      --panel: rgba(18, 22, 32, .82);
      --panel2: rgba(10, 12, 18, .78);
      --text:#e8edf8;
      --muted: rgba(232,237,248,.72);
      --gold:#d4af37;
      --red:#d81b3a;
      --greenfelt:#0b6a3a;
      --greenfelt2:#054428;
      --stroke: rgba(255,255,255,.12);
      --ok:#3cff7f;
      --shadow: 0 18px 45px rgba(0,0,0,.45);
      --radius: 18px;
      --radius2: 14px;
      --btnH: 50px;
      --maxW: 520px;
      --gap: 12px;
    }

    *{box-sizing:border-box;}
    html,body{height:100%; margin:0; padding:0; background: var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;}
    button, input{font-family: inherit;}
    a{color: inherit;}

    /* Safe area + app frame */
    .app{
      min-height:100%;
      padding:
        calc(14px + env(safe-area-inset-top))
        14px
        calc(16px + env(safe-area-inset-bottom))
        14px;
      display:flex;
      justify-content:center;
      align-items:stretch;
    }
    .shell{
      width:100%;
      max-width: var(--maxW);
      min-height: calc(100vh - 30px);
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    /* Generic panels */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .chip{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 12px;
      line-height: 1;
      color: var(--muted);
      white-space:nowrap;
    }
    .chip strong{color: var(--text); font-weight: 650;}
    .content{
      flex:1;
      min-height:0;
      border:1px solid var(--stroke);
      background: var(--panel2);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .screen{
      position:absolute;
      inset:0;
      display:none;
      flex-direction:column;
      min-height:0;
    }
    .screen.active{display:flex;}

    .scroll{
      flex:1;
      min-height:0;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      padding: 16px;
      display:flex;
      flex-direction:column;
      gap: 14px;
    }

    /* Dialog */
    .dialog{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.55);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
    }
    .dialogTitle{
      font-weight: 800;
      letter-spacing:.2px;
      font-size: 14px;
      margin:0 0 6px 0;
    }
    .dialogText{
      margin:0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }

    /* Buttons */
    .btnRow{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
    }
    .btn{
      height: var(--btnH);
      border-radius: 14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 0 14px;
      font-weight: 750;
      letter-spacing:.2px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      flex: 1 1 140px;
      min-width: 140px;
    }
    .btn:active{transform: translateY(1px);}
    .btn.primary{
      border-color: rgba(212,175,55,.45);
      background: linear-gradient(180deg, rgba(212,175,55,.18), rgba(255,255,255,.06));
    }
    .btn.danger{
      border-color: rgba(216,27,58,.4);
      background: linear-gradient(180deg, rgba(216,27,58,.16), rgba(255,255,255,.06));
    }
    .btn.ghost{
      background: transparent;
    }
    .btn.small{
      height: 44px;
      border-radius: 12px;
      font-weight: 700;
      flex: 1 1 120px;
      min-width: 120px;
    }

    /* Toast */
    .toast{
      position:absolute;
      left: 50%;
      bottom: calc(14px + env(safe-area-inset-bottom));
      transform: translateX(-50%);
      background: rgba(0,0,0,.72);
      border: 1px solid var(--stroke);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      box-shadow: 0 18px 40px rgba(0,0,0,.5);
      display:none;
      max-width: calc(100% - 24px);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      backdrop-filter: blur(8px);
    }
    .toast.show{display:block; animation: toastIn .18s ease-out;}
    @keyframes toastIn{
      from{opacity:0; transform: translateX(-50%) translateY(8px);}
      to{opacity:1; transform: translateX(-50%) translateY(0);}
    }

    /* HOME: green felt scene */
    .felt{
      position:relative;
      flex:1;
      min-height:0;
      background:
        radial-gradient(1200px 600px at 30% 15%, rgba(255,255,255,.07), transparent 60%),
        radial-gradient(900px 500px at 80% 60%, rgba(0,0,0,.35), transparent 60%),
        linear-gradient(180deg, var(--greenfelt), var(--greenfelt2));
      overflow:hidden;
    }
    .felt::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(circle at 30% 35%, rgba(255,255,255,.12) 0 2px, transparent 3px),
        radial-gradient(circle at 70% 55%, rgba(255,255,255,.10) 0 2px, transparent 3px),
        radial-gradient(circle at 55% 25%, rgba(255,255,255,.08) 0 2px, transparent 3px);
      opacity:.35;
      filter: blur(.3px);
      pointer-events:none;
    }

    .tableWrap{
      position:relative;
      min-height: 440px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      padding: 18px;
      gap: 14px;
    }
    .cardsRow{
      display:flex;
      gap: 14px;
      justify-content:center;
      align-items:flex-end;
      padding-top: 10px;
      flex-wrap:nowrap;
    }

    .card{
      width: min(44vw, 190px);
      max-width: 190px;
      aspect-ratio: 2.5 / 3.5;
      border-radius: 18px;
      background:
        linear-gradient(145deg, rgba(255,255,255,.98), rgba(255,255,255,.88));
      border: 1px solid rgba(0,0,0,.12);
      box-shadow: 0 18px 35px rgba(0,0,0,.35);
      position:relative;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
      overflow:hidden;
      transform: translateZ(0);
    }
    .card:active{transform: translateY(1px);}
    .card::after{
      content:"";
      position:absolute;
      inset:-40%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.45), transparent);
      transform: rotate(20deg) translateX(-40%);
      animation: shine 3.2s linear infinite;
      opacity:.55;
      pointer-events:none;
    }
    @keyframes shine{
      0%{transform: rotate(20deg) translateX(-60%);}
      100%{transform: rotate(20deg) translateX(60%);}
    }

    .cardMark{
      position:absolute;
      top: 10px;
      left: 10px;
      width: 44px;
      height: 44px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(0,0,0,.04);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 950;
      font-size: 18px;
    }
    .cardMark.br{
      top:auto; left:auto;
      right: 10px; bottom: 10px;
      transform: rotate(180deg);
    }
    .cardCenter{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap: 10px;
      padding: 16px;
      text-align:center;
    }
    .ace{
      font-size: 44px;
      font-weight: 950;
      letter-spacing: 1px;
      color: rgba(0,0,0,.82);
      line-height: 1;
    }
    .role{
      font-size: 13px;
      font-weight: 850;
      color: rgba(0,0,0,.62);
      letter-spacing:.5px;
    }

    .gloveHand{
      position:absolute;
      right: -18px;
      bottom: -8px;
      width: 220px;
      height: 220px;
      opacity:.92;
      pointer-events:none;
      filter: drop-shadow(0 20px 35px rgba(0,0,0,.35));
      transform: rotate(-8deg);
    }

    /* LOADING / dealer scene */
    .stage{
      position:relative;
      flex:1;
      min-height:0;
      background:
        radial-gradient(1200px 700px at 50% 15%, rgba(216,27,58,.12), transparent 55%),
        radial-gradient(900px 600px at 80% 70%, rgba(212,175,55,.08), transparent 60%),
        linear-gradient(180deg, #090b11, #05060a);
      overflow:hidden;
    }
    .stage::before{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(circle at 10% 25%, rgba(255,255,255,.10) 0 1px, transparent 2px),
        radial-gradient(circle at 90% 35%, rgba(255,255,255,.08) 0 1px, transparent 2px),
        radial-gradient(circle at 45% 70%, rgba(255,255,255,.07) 0 1px, transparent 2px),
        radial-gradient(circle at 70% 85%, rgba(255,255,255,.05) 0 1px, transparent 2px);
      opacity:.25;
      filter: blur(.2px);
      pointer-events:none;
    }
    .dealerWrap{
      display:flex;
      flex-direction:column;
      gap: 14px;
      align-items:center;
      justify-content:flex-end;
      min-height: 420px;
      padding: 18px;
    }
    .dealerFigure{
      width: min(70vw, 320px);
      max-width: 320px;
      aspect-ratio: 1 / 1;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity .28s ease, transform .28s ease;
    }
    .dealerFigure.show{opacity:1; transform: translateY(0);}
    .pickCard{
      width: min(68vw, 300px);
      max-width: 300px;
      opacity:.95;
      filter: drop-shadow(0 18px 30px rgba(0,0,0,.45));
    }

    /* STARFIELD background for generator screens */
    .stars{
      position:absolute;
      inset:0;
      overflow:hidden;
      pointer-events:none;
      opacity:.55;
    }
    .stars::before,
    .stars::after{
      content:"";
      position:absolute;
      inset:-50%;
      background:
        radial-gradient(circle, rgba(255,255,255,.25) 0 1px, transparent 2px) 0 0/140px 140px,
        radial-gradient(circle, rgba(255,255,255,.18) 0 1px, transparent 2px) 40px 20px/180px 180px,
        radial-gradient(circle, rgba(255,255,255,.12) 0 1px, transparent 2px) 70px 60px/220px 220px;
      animation: drift 18s linear infinite;
      filter: blur(.2px);
    }
    .stars::after{
      opacity:.65;
      animation-duration: 26s;
      animation-direction: reverse;
    }
    @keyframes drift{
      0%{transform: translate3d(0,0,0);}
      100%{transform: translate3d(90px,140px,0);}
    }

    /* Titles */
    h1{
      margin:0;
      font-size: 18px;
      line-height: 1.15;
      letter-spacing:.2px;
    }
    .sub{
      margin:0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }

    /* Machine / dice */
    .machineRow{
      display:flex;
      justify-content:center;
      align-items:center;
      padding: 6px 0 2px;
    }
    .slot{
      width: min(92%, 420px);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.28));
      border: 1px solid rgba(212,175,55,.25);
      box-shadow: 0 22px 45px rgba(0,0,0,.45);
      position:relative;
      padding: 14px 14px 16px;
    }
    .slotTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .slotBadge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size: 12px;
      color: rgba(212,175,55,.92);
      font-weight: 850;
      letter-spacing:.4px;
      white-space:nowrap;
    }
    .slotReels{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      padding: 10px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.35);
    }
    .reel{
      width: 70px;
      height: 74px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
    }
    .reelNum{
      font-weight: 950;
      font-size: 34px;
      letter-spacing: 1px;
      color: rgba(255,255,255,.92);
      text-shadow: 0 8px 18px rgba(0,0,0,.45);
    }
    .slotLever{
      width: 88px;
      height: 44px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
      padding: 0 12px;
    }
    .leverKnob{
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.95), rgba(255,255,255,.22));
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 10px 20px rgba(0,0,0,.35);
    }
    .leverText{
      font-size: 12px;
      font-weight: 850;
      color: var(--muted);
      letter-spacing:.2px;
      white-space:nowrap;
    }
    .slotLever:active{transform: translateY(1px);}
    .slot.win{
      box-shadow: 0 22px 45px rgba(0,0,0,.45), 0 0 0 1px rgba(212,175,55,.22), 0 0 28px rgba(212,175,55,.14);
    }
    .reel.spin .reelNum{
      animation: spin .48s ease-in-out;
    }
    @keyframes spin{
      0%{transform: translateY(0); opacity:1;}
      30%{transform: translateY(12px); opacity:.55;}
      60%{transform: translateY(-10px); opacity:.7;}
      100%{transform: translateY(0); opacity:1;}
    }

    .diceWrap{
      width: min(92%, 420px);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.28));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 22px 45px rgba(0,0,0,.45);
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }
    .diceRow{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 12px;
      flex-wrap:nowrap;
    }
    .cupBtn, .diceBtn{
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    .cupBtn{
      width: 116px;
      height: 88px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      padding: 10px;
    }
    .dice{
      width: 74px;
      height: 74px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      position:relative;
      overflow:hidden;
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
    }
    .pip{
      position:absolute;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.92);
      box-shadow: 0 8px 18px rgba(0,0,0,.35);
      opacity:0;
    }
    .dice.spin{animation: diceSpin .35s ease;}
    @keyframes diceSpin{
      0%{transform: rotate(0) translateY(0);}
      45%{transform: rotate(8deg) translateY(-2px);}
      100%{transform: rotate(0) translateY(0);}
    }

    /* Brief block */
    .brief{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      border-radius: var(--radius);
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .kv{
      display:flex;
      gap: 10px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .k{
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
      letter-spacing:.2px;
      min-width: 140px;
    }
    .v{
      flex: 1 1 220px;
      font-size: 13px;
      line-height: 1.35;
      font-weight: 700;
      word-break: break-word;
      min-width: 180px;
      text-align:left;
    }
    .emptyHint{
      color: rgba(232,237,248,.55);
      font-size: 12.5px;
      line-height: 1.35;
    }

    /* Checkboxes */
    .checks{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      border-radius: var(--radius);
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .checksTitle{
      font-size: 12px;
      font-weight: 900;
      letter-spacing:.25px;
      color: rgba(232,237,248,.78);
      margin:0;
    }
    .checkGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .check{
      display:flex;
      align-items:center;
      gap: 10px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      border-radius: 14px;
      padding: 10px 10px;
      min-height: 46px;
    }
    .check input{
      width: 18px; height: 18px;
      accent-color: var(--gold);
      flex: 0 0 auto;
    }
    .check span{
      font-size: 13px;
      font-weight: 750;
      color: rgba(232,237,248,.9);
      line-height: 1.2;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .otherRow{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .otherInput{
      flex: 1 1 220px;
      min-width: 190px;
      height: 46px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color: var(--text);
      padding: 0 12px;
      font-size: 13px;
      outline:none;
    }
    .otherInput::placeholder{color: rgba(232,237,248,.42);}

    /* Footer buttons always visible (but not stuck if scroll small) */
    .footerBar{
      padding: 14px 16px 16px;
      border-top: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    /* Small helpers */
    .row{
      display:flex; gap: 10px; align-items:center; flex-wrap:wrap;
    }
    .sep{
      height: 1px;
      background: rgba(255,255,255,.10);
      width:100%;
    }
    .muted{color: var(--muted);}

    /* Make sure tiny phones still fit */
    @media (max-width: 360px){
      .btn{min-width: 120px;}
      .reel{width: 64px; height: 70px;}
      .card{width: 44vw;}
      .checkGrid{grid-template-columns: 1fr;}
      .k{min-width: 120px;}
      .v{min-width: 160px;}
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="shell">
      <div class="topbar">
        <div class="brand">
          <div class="chip"><strong>CASINO</strong> кейсы</div>
          <div class="chip" id="roleChip">роль: <strong>не выбрана</strong></div>
        </div>
        <div class="chip" id="statusChip">готово</div>
      </div>

      <div class="content" id="content">
        <div class="toast" id="toast">Скопировано</div>

        <!-- SCREEN 1: HOME -->
        <section class="screen active" id="screenHome" aria-label="Домашняя">
          <div class="felt">
            <div class="tableWrap">
              <div class="dialog">
                <p class="dialogTitle">Выберите карту</p>
                <p class="dialogText">Нажмите на любую. Дальше будет небольшая сцена, а потом генератор.</p>
              </div>

              <div class="cardsRow" role="group" aria-label="Выбор карты">
                <div class="card" id="cardM" data-role="marketing" aria-label="Карта маркетолога" title="Маркетолог">
                  <div class="cardMark">М</div>
                  <div class="cardMark br">М</div>
                  <div class="cardCenter">
                    <div class="ace">A</div>
                    <div class="role">МАРКЕТОЛОГ</div>
                  </div>
                </div>

                <div class="card" id="cardD" data-role="design" aria-label="Карта дизайнера" title="Дизайнер">
                  <div class="cardMark">Д</div>
                  <div class="cardMark br">Д</div>
                  <div class="cardCenter">
                    <div class="ace">A</div>
                    <div class="role">ДИЗАЙНЕР</div>
                  </div>
                </div>
              </div>

              <!-- White glove hand placing cards -->
              <svg class="gloveHand" viewBox="0 0 200 200" aria-hidden="true">
                <defs>
                  <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
                    <stop offset="0" stop-color="rgba(255,255,255,.96)"/>
                    <stop offset="1" stop-color="rgba(255,255,255,.68)"/>
                  </linearGradient>
                </defs>
                <path d="M55 120c10-22 20-36 32-44 8-5 14-4 18 2 4 6 3 14-2 21l-7 10 14-12c9-8 17-10 22-5 5 5 3 13-6 22l-11 11 16-9c11-6 19-6 23-1 4 5 1 12-10 20l-20 14c-10 7-21 11-34 12-21 2-33-6-35-23z"
                      fill="url(#g1)" stroke="rgba(0,0,0,.12)" stroke-width="1.2"/>
                <path d="M40 140c10 12 26 20 45 19 18-1 35-7 49-17"
                      fill="none" stroke="rgba(0,0,0,.10)" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </div>
          </div>
        </section>

        <!-- SCREEN 2: LOADING / SCENE -->
        <section class="screen" id="screenScene" aria-label="Сцена">
          <div class="stage">
            <div class="scroll" style="padding-bottom: 10px;">
              <div class="dialog" id="sceneDialog1">
                <p class="dialogTitle">Вы берете карту</p>
                <p class="dialogText">Секунда. Дайте крупье подготовить ставку.</p>
              </div>

              <div class="machineRow" aria-hidden="true">
                <svg class="pickCard" viewBox="0 0 340 220">
                  <defs>
                    <linearGradient id="pc1" x1="0" y1="0" x2="1" y2="1">
                      <stop offset="0" stop-color="rgba(255,255,255,.96)"/>
                      <stop offset="1" stop-color="rgba(255,255,255,.78)"/>
                    </linearGradient>
                    <linearGradient id="pc2" x1="0" y1="0" x2="0" y2="1">
                      <stop offset="0" stop-color="rgba(255,255,255,.55)"/>
                      <stop offset="1" stop-color="rgba(255,255,255,.0)"/>
                    </linearGradient>
                  </defs>
                  <rect x="140" y="40" width="120" height="170" rx="18" fill="url(#pc1)" stroke="rgba(0,0,0,.16)"/>
                  <rect x="150" y="54" width="100" height="22" rx="10" fill="rgba(0,0,0,.06)"/>
                  <text x="200" y="71" text-anchor="middle" font-size="12" font-weight="900" fill="rgba(0,0,0,.55)">ВАША КАРТА</text>

                  <path d="M60 160c15-30 33-48 54-55 16-5 22 3 19 16-2 7-8 15-15 23l25-15c12-7 22-6 25 2 3 8-5 18-22 28l-22 13c-19 11-42 15-64 12"
                        fill="rgba(255,255,255,.86)" stroke="rgba(0,0,0,.12)" stroke-width="1.2"/>
                  <path d="M70 172c12 10 30 13 54 8" fill="none" stroke="rgba(0,0,0,.10)" stroke-width="2" stroke-linecap="round"/>
                  <rect x="140" y="40" width="120" height="170" rx="18" fill="url(#pc2)"/>
                </svg>
              </div>

              <div class="dealerWrap">
                <svg class="dealerFigure" id="dealerFigure" viewBox="0 0 360 360" aria-hidden="true">
                  <defs>
                    <radialGradient id="dGlow" cx="45%" cy="25%" r="70%">
                      <stop offset="0" stop-color="rgba(216,27,58,.25)"/>
                      <stop offset="1" stop-color="rgba(216,27,58,0)"/>
                    </radialGradient>
                    <linearGradient id="dress" x1="0" y1="0" x2="0" y2="1">
                      <stop offset="0" stop-color="rgba(216,27,58,.88)"/>
                      <stop offset="1" stop-color="rgba(120,10,24,.88)"/>
                    </linearGradient>
                  </defs>
                  <circle cx="180" cy="170" r="150" fill="url(#dGlow)"/>
                  <circle cx="180" cy="120" r="34" fill="rgba(255,255,255,.18)"/>
                  <path d="M112 300c18-86 47-126 68-126s50 40 68 126c-48 20-92 20-136 0z" fill="url(#dress)" stroke="rgba(255,255,255,.12)"/>
                  <path d="M130 180c22 20 78 20 100 0" fill="none" stroke="rgba(255,255,255,.14)" stroke-width="6" stroke-linecap="round"/>
                  <path d="M98 246c16-20 34-28 54-26" fill="none" stroke="rgba(255,255,255,.10)" stroke-width="6" stroke-linecap="round"/>
                  <path d="M262 246c-16-20-34-28-54-26" fill="none" stroke="rgba(255,255,255,.10)" stroke-width="6" stroke-linecap="round"/>
                </svg>

                <div class="dialog" id="sceneDialog2" style="display:none;">
                  <p class="dialogTitle">У меня есть пара интересных кейсов для тебя</p>
                  <p class="dialogText">Скажи слово и я прокручу удачу.</p>
                  <div class="btnRow" style="margin-top: 12px;">
                    <button class="btn primary" id="btnGo">Хорошо, идем</button>
                    <button class="btn" id="btnBack">Я не определился с картой</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- SCREEN 3A: DESIGN -->
        <section class="screen" id="screenDesign" aria-label="Дизайн">
          <div class="stars"></div>
          <div class="scroll">
            <div>
              <h1>Генератор кейсов для дизайнеров</h1>
              <p class="sub">Сгенерируйте идею для кейса: можно использовать для лого, презентации, мерча или даже брендбука.</p>
            </div>

            <div class="machineRow">
              <div class="slot" id="slotBox">
                <div class="slotTop">
                  <div class="slotBadge">♠ джекпот по умолчанию</div>
                  <div class="slotLever" id="slotPull" role="button" aria-label="Дернуть ручку">
                    <div class="leverKnob"></div>
                    <div class="leverText">Дернуть</div>
                  </div>
                </div>

                <div class="slotReels" aria-hidden="true">
                  <div class="reel"><div class="reelNum" id="reel1">7</div></div>
                  <div class="reel"><div class="reelNum" id="reel2">7</div></div>
                  <div class="reel"><div class="reelNum" id="reel3">7</div></div>
                </div>
              </div>
            </div>

            <div class="brief" id="designBrief">
              <div class="kv"><div class="k">Название компании:</div><div class="v" id="d_company"><span class="emptyHint">Нажмите на ручку аппарата.</span></div></div>
              <div class="kv"><div class="k">Позиционирование:</div><div class="v" id="d_pos">-</div></div>
              <div class="kv"><div class="k">Основной цвет:</div><div class="v" id="d_color">-</div></div>
              <div class="kv"><div class="k">Продукт:</div><div class="v" id="d_product">-</div></div>
              <div class="kv"><div class="k">Проблема:</div><div class="v" id="d_problem">-</div></div>
            </div>

            <div class="checks" id="designChecks">
              <p class="checksTitle">Что вы хотите сделать (можно несколько):</p>
              <div class="checkGrid">
                <label class="check"><input type="checkbox" value="логотип"><span>логотип</span></label>
                <label class="check"><input type="checkbox" value="мерч"><span>мерч</span></label>
                <label class="check"><input type="checkbox" value="брендбук"><span>брендбук</span></label>
                <label class="check"><input type="checkbox" value="презентацию"><span>презентацию</span></label>
                <label class="check"><input type="checkbox" value="маскота"><span>маскота</span></label>
                <label class="check"><input type="checkbox" value="упаковку"><span>упаковку</span></label>
              </div>
              <div class="otherRow">
                <label class="check" style="flex:0 0 auto; padding-right:12px;">
                  <input type="checkbox" id="chkOther" value="свое">
                  <span>что-то свое</span>
                </label>
                <input class="otherInput" id="otherInput" placeholder="Например: лендинг, гайдлайн для соцсетей, иллюстрации..." />
              </div>
              <p class="sub" style="margin:0;">Подсказка: если выбрано несколько пунктов, я красиво перечислю их в тексте.</p>
            </div>
          </div>

          <div class="footerBar">
            <div class="btnRow">
              <button class="btn primary" id="btnCopyDesign">Скопировать ТЗ</button>
              <button class="btn danger" id="btnClearDesign">Стереть</button>
              <button class="btn" id="btnHomeFromDesign">Домой</button>
            </div>
            <div class="chip" id="designHint">сначала прокрутите аппарат</div>
          </div>
        </section>

        <!-- SCREEN 3B: MARKETING -->
        <section class="screen" id="screenMarketing" aria-label="Маркетинг">
          <div class="stars"></div>
          <div class="scroll">
            <div>
              <h1>Генератор кейсов для маркетологов</h1>
              <p class="sub">Сгенерируйте идею для кейса: можно использовать для презентации, исследования, брендбука, сравнения или любого другого формата.</p>
            </div>

            <div class="machineRow">
              <div class="diceWrap">
                <div class="row" style="justify-content:space-between;">
                  <div class="chip"><strong>кости</strong> + стакан</div>
                  <div class="chip" id="diceLabel">жмите на кости или стакан</div>
                </div>

                <div class="diceRow">
                  <div class="cupBtn" id="cupBtn" role="button" aria-label="Накрыть кости стаканом">
                    <svg width="88" height="64" viewBox="0 0 88 64" aria-hidden="true">
                      <defs>
                        <linearGradient id="cupG" x1="0" y1="0" x2="0" y2="1">
                          <stop offset="0" stop-color="rgba(185,190,205,.32)"/>
                          <stop offset="1" stop-color="rgba(120,125,140,.12)"/>
                        </linearGradient>
                      </defs>
                      <path d="M16 10h56l-10 44H26L16 10z" fill="url(#cupG)" stroke="rgba(255,255,255,.20)" stroke-width="1.2" />
                      <path d="M22 14h44" stroke="rgba(255,255,255,.22)" stroke-width="3" stroke-linecap="round" />
                      <path d="M30 54h28" stroke="rgba(0,0,0,.25)" stroke-width="4" stroke-linecap="round" />
                    </svg>
                  </div>

                  <div class="diceBtn" id="diceBtn" role="button" aria-label="Бросить кости" style="display:flex; gap:12px;">
                    <div class="dice" id="dice1" aria-label="Кость 1"></div>
                    <div class="dice" id="dice2" aria-label="Кость 2"></div>
                  </div>
                </div>

                <p class="sub" style="margin:0; text-align:center;">Каждый раз выпадает случайное сочетание точек. ТЗ тоже меняется.</p>
              </div>
            </div>

            <div class="brief" id="marketingBrief">
              <div class="kv"><div class="k">Название компании:</div><div class="v" id="m_company"><span class="emptyHint">Нажмите на кости или стакан.</span></div></div>
              <div class="kv"><div class="k">Позиционирование:</div><div class="v" id="m_pos">-</div></div>
              <div class="kv"><div class="k">Продукт:</div><div class="v" id="m_product">-</div></div>
              <div class="kv"><div class="k">Проблема:</div><div class="v" id="m_problem">-</div></div>
              <div class="kv"><div class="k">Задача:</div><div class="v" id="m_task">-</div></div>
              <div class="kv"><div class="k">Цели компании:</div><div class="v" id="m_goal">-</div></div>
            </div>
          </div>

          <div class="footerBar">
            <div class="btnRow">
              <button class="btn primary" id="btnCopyMarketing">Скопировать ТЗ</button>
              <button class="btn danger" id="btnClearMarketing">Стереть</button>
              <button class="btn" id="btnHomeFromMarketing">Домой</button>
            </div>
            <div class="chip" id="marketingHint">сначала бросьте кости</div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <script>
    // Telegram init (safe)
    (function initTg(){
      try{
        if (window.Telegram && Telegram.WebApp){
          Telegram.WebApp.ready();
          Telegram.WebApp.expand();
          // Optional: set header/background colors if supported
          try { Telegram.WebApp.setHeaderColor?.("#0b0e14"); } catch(e){}
          try { Telegram.WebApp.setBackgroundColor?.("#0b0e14"); } catch(e){}
        }
      } catch (e) {}
    })();

    // Helpers
    const $ = (id) => document.getElementById(id);
    const toast = $("toast");
    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toast.classList.remove("show"), 1200);
    }

    function setStatus(text){ $("statusChip").textContent = text; }

    function pick(arr){
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function switchScreen(screenId){
      const screens = ["screenHome","screenScene","screenDesign","screenMarketing"];
      screens.forEach(id => $(id).classList.toggle("active", id === screenId));
      // ensure scroll top on screen change
      const active = $(screenId);
      const sc = active.querySelector(".scroll");
      if (sc) sc.scrollTop = 0;
    }

    // Data (50 each)
    const companyNames = [
      "Velvet Pine","Neon Harbor","Atlas & Co","Golden Finch","Paper Tiger Studio","North Mint","LumaCraft","Brick & Bloom","Silver Anchor","SoftGrid",
      "Rocket Apricot","Urban Fern","Moonlit Market","Coral Junction","Quiet Storm Lab","Honey Circuit","Stonewave","Frost & Fire","Citrus Union","Sunline Works",
      "Cloudberry","Kinetic Owl","Blue Marlin","Amber Avenue","Walnut & Wire","Nova Nectar","Crisp Corner","Granite Fox","Rosewood Road","Lime Ledger",
      "Nightingale Supply","Pixel Pier","Driftwood Desk","Bloom Barrel","Iron Petal","Maple Metro","Flash & Felt","Copper Kite","Tide & Timber","Arctic Apron",
      "Prism Pantry","Echo Orchard","Marble Meadow","Spark Station","Cedar Soda","Velvet Valley","Mint Mechanics","Aurora Alley","Lantern Loop","Orbit Orange"
    ];

    const positioning = [
      "Премиум без пафоса, просто качественно.","Самый быстрый сервис в нише, без бюрократии.","Доступный продукт, который выглядит дороже своей цены.","Забота о клиенте как у лучших консьержей.",
      "Честность: без скрытых условий и мелкого шрифта.","Технологично, но по-человечески понятно.","Для тех, кто ценит минимализм и порядок.","Ярко, смело, с характером.",
      "Экологично, но без морализаторства.","Сделано рядом, локальная гордость.","Экспертность: мы узкие профи, не обо всем сразу.","Лучший выбор для новичков, всё разжевано.",
      "Для продвинутых, кому важны детали.","Уютный бренд, который хочется рекомендовать.","Дерзкий бренд для тех, кто устал от скучного.","Надежность и стабильность, как швейцарские часы.",
      "Гибкость: подстроимся под клиента.","Всё под ключ, чтобы клиент не бегал.","Красиво и функционально, без просто красиво.","Нишевый стиль: мы не массовый рынок.",
      "Сервис 24/7, всегда на связи.","Максимум пользы за минимальное время.","Вдохновляем и упрощаем жизнь.","Комьюнити вокруг бренда, не просто продукт.",
      "Сильная выгода без ощущения дешевки.","Безопасность и спокойствие клиента на первом месте.","Суперпонятный продукт для занятых людей.","Выбор эстетов, кто любит вау.",
      "Бренд, который не раздражает, а радует.","Игровой вайб, но профессиональная начинка.","Ставка на результат, а не на процесс.","Индивидуальность: никаких шаблонов.",
      "Простота: один клик и готово.","Консервативно, солидно, по делу.","Модно и актуально, но без перегиба.","Научный подход, цифры и проверки.",
      "Теплый тон и человеческий язык.","Для семей и спокойного быта.","Для активной городской жизни.","Для тех, кто любит статус и детали.",
      "Премиум-опыт даже в мелочах.","Четко, структурно, без лишнего.","Вдохновение из культуры и искусства.","Ремесленный подход: вручную, с душой.",
      "Суперскорость и оперативность.","Меньше слов, больше дела.","Рациональный выбор, который легко объяснить.","Смелый дизайн, но понятная ценность.",
      "Традиции, но современная подача.","Мы на твоей стороне, всегда про клиента."
    ];

    const products = [
      "Приложение для учета личных финансов.","Доставка фермерских продуктов.","Онлайн-курсы по профессии.","Сервис бронирования мастеров.","Умная подписка на витамины.",
      "Кофе в дрип-пакетах.","Премиальные корма для животных.","Наборы для домашней пасты.","CRM для малого бизнеса.","Сервис поиска стажировок.",
      "Маркетплейс локальных брендов.","Платформа для корпоративного обучения.","Сервис аренды техники.","Доставка готовых рационов.","Подписка на книги и аудио.",
      "Банк рецептов с планированием меню.","Микро-страховки для поездок.","Платформа для проведения вебинаров.","Косметика для чувствительной кожи.","Сервис хранения фото и семейных архивов.",
      "Умные термокружки и аксессуары.","Магазин дизайнерской мебели.","Онлайн-запись в клиники.","Трекер привычек и сна.","Юридический конструктор договоров.",
      "Сервис доставки воды и бытовых мелочей.","Билеты и афиша мероприятий.","Приложение для изучения языка.","Сервис поиска жилья на месяц.","Подписка на уход за обувью.",
      "Эко-упаковка для бизнеса.","Конструктор сайтов без кода.","Продукты для умного дома.","Коворкинг и переговорки по подписке.","Сервис проверки контрагентов.",
      "Наборы для ухода за бородой.","Спортивная одежда для города.","Подбор психолога онлайн.","Сервис доставки цветов.","Платформа для фриланс-заказов.",
      "Облачная бухгалтерия.","Доставка редких специй.","Туристические авторские маршруты.","Велопрокат по городу.","Электронные подарочные сертификаты.",
      "Сервис подбора подарков.","Услуги клининга.","Домашние растения с доставкой.","Платформа для подкастеров.","Приложение для медитации."
    ];

    const colors = [
      "Изумрудный #0B8A4A","Сочный лайм #7CFF00","Темный нефрит #0A5A3B","Бордо #6D0F2B","Рубиновый #B0003A",
      "Кармин #D4002A","Ночной синий #0B1D3A","Королевский синий #1D4ED8","Индиго #3F2E9E","Фиолетовый бархат #4B145E",
      "Лавандовый #B79DFF","Пудровый розовый #F2B5C6","Персиковый #FFB089","Янтарный #FFB000","Золото #D4AF37",
      "Песочный #D8C3A5","Кофейный #5A3A2E","Шоколад #3B1F1F","Графит #2B2E34","Угольный #111318",
      "Серебро #C7CCD6","Молочный #F6F1E8","Белый холодный #F5F8FF","Мятный #7EF2C2","Бирюза #18C7C7",
      "Морская волна #1F9E93","Оливковый #667A2F","Горчичный #C79A2D","Терракота #C2563B","Коралловый #FF5A5F",
      "Малиновый #E11D48","Винный #7A1E3A","Сливовый #5B2245","Сиреневый #9B5DE5","Небесный #38BDF8",
      "Ледяной голубой #A5D8FF","Стальной #6B7280","Медь #B87333","Бронза #8C6239","Латунь #B5A642",
      "Лимонный #FFF000","Салатовый #A3E635","Хвоя #1B4332","Сапфир #0F52BA","Кобальт #0047AB",
      "Пастельный беж #E7D7C1","Пыльный розовый #D8A7B1","Теплый серый #A8A29E","Черный лак #050608","Красный неон #FF0033"
    ];

    // Separate problems
    const problemsMarketing = [
      "Лиды идут, но почти никто не покупает.","Стоимость привлечения клиента растет каждый месяц.","Реклама работает нестабильно, нет предсказуемости.","Мы не понимаем, кто наша самая прибыльная аудитория.",
      "Нет четкого УТП, звучим как все.","Трафик есть, но конверсия на сайте слабая.","Брошенных корзин слишком много.","Люди регистрируются, но не активируются.",
      "Повторные покупки почти отсутствуют.","Сложно масштабировать текущие каналы.","Партнерские каналы не приносят результата.","Слишком длинный цикл сделки.",
      "Слабая аналитика, решения принимаются на ощущениях.","Падает вовлеченность в соцсетях.","Мы зависим от одного канала трафика.","Новая аудитория не доверяет бренду.",
      "Конкуренты агрессивно демпингуют.","Реклама привлекает нецелевой сегмент.","Низкий CTR у объявлений.","Контент не генерирует заявки.",
      "Слабый оффер, не цепляет.","Нет четкой стратегии продвижения.","Команда маркетинга работает разрозненно.","У нас нет понятной воронки.",
      "Сложно зайти в новый регион.","Плохо работает e-mail маркетинг.","Люди не понимают ценность продукта.","Снижается органический трафик.",
      "Нет сильных кейсов для продаж.","Высокий отток подписчиков.","Бренд не запоминается.","Реклама не окупается в нужные сроки.",
      "Нет системы тестирования гипотез.","Слишком низкий средний чек.","Проблемы с позиционированием при выходе на новый сегмент.","Падает конверсия после редизайна сайта.",
      "Мало заявок с мобильных устройств.","Неясно, какие каналы реально приносят прибыль.","Отдел продаж жалуется на холодные лиды.","Слабая репутация в отзывах.",
      "Мы не выделяемся среди конкурентов.","Низкая вовлеченность в рассылках.","Сложно донести сложный продукт простым языком.","Запуск нового продукта прошел без шума.",
      "Акции и скидки не дают роста продаж.","Низкий LTV по сравнению с рынком.","Сложно выстроить омниканальную стратегию.","Нет четкого бренда работодателя.",
      "Слабая работа с ретаргетингом.","Мы растем, но прибыль не увеличивается пропорционально."
    ];

    const problemsDesign = [
      "У компании нет единого визуального стиля.","Логотип выглядит устаревшим.","Айдентика не отражает позиционирование.","Бренд визуально сливается с конкурентами.",
      "Сайт выглядит перегруженным и хаотичным.","Нет брендбука, каждый делает как хочет.","Упаковка продукта не продает.","Визуал в соцсетях разный и несистемный.",
      "Дизайн не вызывает доверия.","Сложно адаптировать стиль под разные носители.","Нет визуального кода, который запоминается.","Слишком много цветов, нет фокуса.",
      "Шрифты используются хаотично.","Презентации выглядят скучно и шаблонно.","Мерч не хочется носить.","Визуал не передает ценность продукта.",
      "Иллюстрации выглядят дешево.","Фото-стиль не определен.","Логотип плохо читается в маленьком размере.","Нет адаптации под мобильные устройства.",
      "Дизайн устарел морально.","Визуал не соответствует целевой аудитории.","Нет системы и модульности в макетах.","Бренд выглядит слишком безликим.",
      "Цвета не поддерживают эмоцию бренда.","Слишком агрессивный визуальный стиль.","Слишком скучный и стерильный стиль.","Нет единого визуального языка для рекламы.",
      "Иконки и графика разностильные.","Презентации не продают идею.","Дизайн не отражает премиальность.","Дизайн не отражает доступность.",
      "Витрина на маркетплейсе выглядит слабее конкурентов.","Носители бренда не узнаются как единое целое.","Нет маскота или визуального персонажа, который можно развивать.","Упаковка теряется на полке.",
      "Сайт визуально сложен для восприятия.","Не хватает вау-эффекта.","Дизайн слишком сложный в производстве.","Нет гайдлайнов для подрядчиков.",
      "Слишком много декоративных элементов.","Недостаточно акцентов и иерархии.","Нет визуального контраста.","Бренд не вызывает эмоций.",
      "Старый фирменный стиль мешает масштабированию.","Визуал не подходит для выхода в новый сегмент.","Дизайн плохо смотрится в темной теме.","Нет адаптивных версий логотипа.",
      "Бренд не считывается за 3 секунды.","Дизайн не поддерживает маркетинговые задачи."
    ];

    const tasks = [
      "Повысить конверсию лендинга в заявку.","Удешевить стоимость лида на 25%.","Запустить позиционирование и обновить месседжи.","Собрать медиаплан на 3 месяца.",
      "Придумать и протестировать 5 офферов.","Перепаковать продуктовую линейку и тарифы.","Настроить воронку удержания и возврата.","Провести исследование аудитории и сегментацию.",
      "Сделать план контента на месяц под лиды.","Поднять продажи в несезон.","Увеличить повторные покупки.","Настроить базовую аналитику и атрибуцию.",
      "Запустить реферальную программу.","Разработать УТП для нового сегмента.","Подготовить стратегию выхода на новый рынок.","Увеличить регистрации, сохранив качество лидов.",
      "Запустить лид-магнит и сбор базы.","Сделать конкурентный анализ и выводы.","Перезапустить e-mail цепочки.","Поднять вовлеченность в соцсетях без кринжа.",
      "Сформировать комьюнити вокруг бренда.","Улучшить онбординг в приложении.","Снизить брошенные корзины.","Поднять средний чек через апсейл.",
      "Запустить PR-повод и инфоповестку.","Сделать стратегию для маркетплейсов.","Настроить связку реклама + квиз.","Провести A/B тесты ключевых экранов.",
      "Переписать тексты на сайте под ясность и доверие.","Разработать коммуникации для запуска продукта.","Наладить партнерский канал продаж.","Увеличить долю органического трафика.",
      "Сформировать бренд-гайд по тону коммуникации.","Подготовить презентацию для инвесторов или партнеров.","Упаковать кейсы и доказательства.","Построить стратегию для ретаргетинга.",
      "Запустить серию вебинаров под продажи.","Подготовить план промо-акций без скидочной ямы.","Снизить отток подписчиков.","Протестировать новый канал привлечения.",
      "Увеличить долю B2B лидов.","Сделать стратегию коммуникаций в кризис.","Выстроить pipeline гипотез и тестов.","Перезапустить бренд, не потеряв старых клиентов.",
      "Улучшить карточки товара и витрину.","Поднять NPS и собрать обратную связь.","Сформировать линейку трипваеров.","Придумать механики геймификации.",
      "Упаковать ценность в 3 простых сообщения.","Пересобрать продуктовую матрицу под прибыль."
    ];

    const goals = [
      "Выйти на +30% выручки за квартал.","Удержать CAC в заданном коридоре.","Увеличить долю повторных покупок до 35%.","Снизить отток на 20%.",
      "Нарастить базу подписчиков на 10 000.","Увеличить средний чек на 15%.","Увеличить конверсию в оплату на 10%.","Запустить новый продукт и получить 1000 продаж.",
      "Выйти в 2 новых региона.","Сформировать устойчивый органический трафик.","Увеличить узнаваемость в целевой аудитории.","Сократить цикл сделки на 25%.",
      "Нарастить долю B2B в выручке.","Получить 50 партнеров-реселлеров.","Добиться окупаемости рекламы в пределах 30 дней.","Поднять NPS до 60+.",
      "Увеличить LTV на 20%.","Снизить возвраты на 15%.","Выйти в топ-3 по нишевым запросам SEO.","Собрать и систематизировать аналитику по всем каналам.",
      "Увеличить количество лидов на 40%.","Улучшить качество лидов и снизить долю мусора.","Сделать бренд более премиальным в восприятии.","Увеличить долю прямых продаж.",
      "Увеличить продажи в несезон на 25%.","Запустить комьюнити и получить 500 активных участников.","Увеличить долю рекомендаций.","Выйти на стабильные 3 PR-упоминания в месяц.",
      "Поднять посещаемость сайта на 50%.","Увеличить конверсию из соцсетей в заявки.","Снизить стоимость лида на 20%.","Выйти на новые сегменты аудитории.",
      "Увеличить продажи через маркетплейсы.","Укрепить доверие, поднять рейтинг и отзывы.","Увеличить долю повторных оплат подписки.","Достичь 1 млн просмотров контента в месяц.",
      "Увеличить число регистраций в приложении.","Поднять эффективность ретаргетинга.","Перепаковать офферы и поднять конверсию.","Сформировать единый брендбук и коммуникации.",
      "Закрыть план продаж по ключевому продукту.","Увеличить долю теплых лидов.","Поднять маржинальность на 5 п.п.","Стабилизировать продажи без постоянных скидок.",
      "Сформировать линейку лид-магнитов и трипваеров.","Наладить регулярные A/B тесты каждую неделю.","Увеличить количество заявок с мобайла.","Снизить число брошенных корзин.",
      "Увеличить конверсию онбординга.","Выйти на предсказуемый рост месяц к месяцу."
    ];

    // App state
    const state = {
      role: null,         // "design" | "marketing"
      designBrief: null,
      marketingBrief: null,
      dice: [6,6],
      hasDesign: false,
      hasMarketing: false
    };

    // UI elements
    const roleChip = $("roleChip");

    function setRole(role){
      state.role = role;
      roleChip.innerHTML = role === "design"
        ? 'роль: <strong>дизайнер</strong>'
        : role === "marketing"
          ? 'роль: <strong>маркетолог</strong>'
          : 'роль: <strong>не выбрана</strong>';
    }

    // Scene flow
    function startScene(){
      setStatus("сцена...");
      switchScreen("screenScene");
      $("sceneDialog2").style.display = "none";
      $("dealerFigure").classList.remove("show");

      // small staged reveal
      clearTimeout(startScene._t1);
      clearTimeout(startScene._t2);
      startScene._t1 = setTimeout(()=>{
        $("dealerFigure").classList.add("show");
      }, 650);

      startScene._t2 = setTimeout(()=>{
        $("sceneDialog2").style.display = "block";
        setStatus("ожидаю");
      }, 950);
    }

    // Dice rendering
    function setDiceFace(el, value){
      el.innerHTML = "";
      const pos = {
        tl:[18,18], tr:[56,18],
        ml:[18,37], mr:[56,37],
        bl:[18,56], br:[56,56],
        c:[37,37]
      };

      const layout = {
        1:["c"],
        2:["tl","br"],
        3:["tl","c","br"],
        4:["tl","tr","bl","br"],
        5:["tl","tr","c","bl","br"],
        6:["tl","ml","bl","tr","mr","br"]
      }[value];

      layout.forEach(key=>{
        const [x,y] = pos[key];
        const d = document.createElement("div");
        d.className = "pip";
        d.style.left = (x-5) + "px";
        d.style.top = (y-5) + "px";
        d.style.opacity = "1";
        el.appendChild(d);
      });
    }

    function rollDice(){
      const d1 = 1 + Math.floor(Math.random()*6);
      const d2 = 1 + Math.floor(Math.random()*6);
      state.dice = [d1,d2];

      const dice1 = $("dice1");
      const dice2 = $("dice2");
      dice1.classList.remove("spin");
      dice2.classList.remove("spin");
      // trigger reflow to restart animation
      void dice1.offsetWidth;

      dice1.classList.add("spin");
      dice2.classList.add("spin");

      setDiceFace(dice1, d1);
      setDiceFace(dice2, d2);

      $("diceLabel").textContent = `выпало: ${d1} + ${d2}`;
    }

    // Generate briefs
    function generateDesignBrief(){
      const brief = {
        company: pick(companyNames),
        pos: pick(positioning),
        color: pick(colors),
        product: pick(products),
        problem: pick(problemsDesign)
      };
      state.designBrief = brief;
      state.hasDesign = true;

      $("d_company").textContent = brief.company;
      $("d_pos").textContent = brief.pos;
      $("d_color").textContent = brief.color;
      $("d_product").textContent = brief.product;
      $("d_problem").textContent = brief.problem;

      $("designHint").textContent = "джекпот: ТЗ готово";
      setStatus("выигрыш");
      persist();
    }

    function generateMarketingBrief(){
      const brief = {
        company: pick(companyNames),
        pos: pick(positioning),
        product: pick(products),
        problem: pick(problemsMarketing),
        task: pick(tasks),
        goal: pick(goals)
      };
      state.marketingBrief = brief;
      state.hasMarketing = true;

      $("m_company").textContent = brief.company;
      $("m_pos").textContent = brief.pos;
      $("m_product").textContent = brief.product;
      $("m_problem").textContent = brief.problem;
      $("m_task").textContent = brief.task;
      $("m_goal").textContent = brief.goal;

      $("marketingHint").textContent = "ставка сыграла: ТЗ готово";
      setStatus("выигрыш");
      persist();
    }

    // Slot animation + always win
    function spinSlot(){
      const reels = [
        $("reel1").parentElement,
        $("reel2").parentElement,
        $("reel3").parentElement
      ];
      reels.forEach(r=> r.classList.add("spin"));
      $("slotBox").classList.add("win");
      setStatus("крутим...");

      setTimeout(()=>{
        reels.forEach(r=> r.classList.remove("spin"));
        // Always 777 but still new brief
        $("reel1").textContent = "7";
        $("reel2").textContent = "7";
        $("reel3").textContent = "7";
        generateDesignBrief();
      }, 520);
    }

    // Checkboxes selection -> nice string
    function getDesignDeliverables(){
      const checks = [...$("designChecks").querySelectorAll('input[type="checkbox"]')];
      const selected = [];
      checks.forEach(ch=>{
        if (ch.checked){
          if (ch.id === "chkOther") return;
          selected.push(ch.value);
        }
      });

      const otherChecked = $("chkOther").checked;
      const otherText = $("otherInput").value.trim();
      if (otherChecked && otherText){
        selected.push(otherText);
      } else if (otherChecked && !otherText){
        selected.push("что-то свое");
      }

      // return a human list
      if (!selected.length) return "какой-то дизайн-материал";
      if (selected.length === 1) return selected[0];
      if (selected.length === 2) return selected[0] + " и " + selected[1];
      return selected.slice(0, -1).join(", ") + " и " + selected[selected.length - 1];
    }

    // Copy text builders (with your agreed wording fixes)
    function buildDesignCopyText(){
      if (!state.designBrief) return null;
      const b = state.designBrief;
      const deliverables = getDesignDeliverables();

      return (
`Привет, я представитель компании ${b.company}. Мы занимаемся в основном реализацией ${b.product} и вот недавно столкнулись со следующей проблемой: ${b.problem}.

Нам срочно нужна твоя помощь! Директор по маркетингу очень просит сделать для нас ${deliverables}. И просит учесть, что ${b.color} - это наш основной цвет, и в целом сам дизайн должен поддерживать наше позиционирование: ${b.pos}.

В целом мы готовы рассмотреть твои предложения по вайбу и общему настроению - мы доверяем тебе как специалисту. Ноль правок! Ждем твое решение!`
      );
    }

    function buildMarketingCopyText(){
      if (!state.marketingBrief) return null;
      const b = state.marketingBrief;

      return (
`Привет, я представитель компании ${b.company}. Мы занимаемся в основном реализацией ${b.product} и вот недавно столкнулись со следующей проблемой: ${b.problem}.

Нам срочно нужна твоя помощь! Директор по маркетингу очень просит твоей помощи: помоги решить нашу задачу - ${b.task}.

Думаю, ты и так знаешь, что решение должно коррелироваться с позиционированием (${b.pos}). В этом квартале наша основная цель: ${b.goal}.

Ноль правок! Ждем твое решение!`
      );
    }

    async function copyToClipboard(text){
      try{
        await navigator.clipboard.writeText(text);
        showToast("Скопировано в буфер");
        return true;
      }catch(e){
        // fallback
        try{
          const ta = document.createElement("textarea");
          ta.value = text;
          ta.style.position = "fixed";
          ta.style.left = "-9999px";
          document.body.appendChild(ta);
          ta.focus();
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
          showToast("Скопировано");
          return true;
        }catch(err){
          showToast("Не получилось скопировать");
          return false;
        }
      }
    }

    // Clear
    function clearDesign(){
      state.designBrief = null;
      state.hasDesign = false;
      $("d_company").innerHTML = '<span class="emptyHint">Нажмите на ручку аппарата.</span>';
      $("d_pos").textContent = "-";
      $("d_color").textContent = "-";
      $("d_product").textContent = "-";
      $("d_problem").textContent = "-";
      $("designHint").textContent = "сначала прокрутите аппарат";

      // uncheck
      [...$("designChecks").querySelectorAll('input[type="checkbox"]')].forEach(ch=> ch.checked = false);
      $("otherInput").value = "";
      setStatus("готово");
      persist();
      showToast("Стерто");
    }

    function clearMarketing(){
      state.marketingBrief = null;
      state.hasMarketing = false;
      $("m_company").innerHTML = '<span class="emptyHint">Нажмите на кости или стакан.</span>';
      $("m_pos").textContent = "-";
      $("m_product").textContent = "-";
      $("m_problem").textContent = "-";
      $("m_task").textContent = "-";
      $("m_goal").textContent = "-";
      $("marketingHint").textContent = "сначала бросьте кости";
      $("diceLabel").textContent = "жмите на кости или стакан";

      // reset dice to 6/6
      state.dice = [6,6];
      setDiceFace($("dice1"), 6);
      setDiceFace($("dice2"), 6);

      setStatus("готово");
      persist();
      showToast("Стерто");
    }

    // Persistence
    const LS_KEY = "casino_cases_v1";
    function persist(){
      try{
        const payload = {
          role: state.role,
          designBrief: state.designBrief,
          marketingBrief: state.marketingBrief,
          dice: state.dice,
          checks: [...$("designChecks").querySelectorAll('input[type="checkbox"]')].map(ch=>({id: ch.id || null, v: ch.value, checked: ch.checked})),
          other: $("otherInput").value
        };
        localStorage.setItem(LS_KEY, JSON.stringify(payload));
      } catch(e){}
    }
    function restore(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return;
        const p = JSON.parse(raw);

        if (p.role) setRole(p.role);

        // restore checkboxes
        if (p.checks && Array.isArray(p.checks)){
          const map = new Map(p.checks.map(x => [x.id ? ("#"+x.id) : ("[value='"+x.v+"']"), x.checked]));
          [...$("designChecks").querySelectorAll('input[type="checkbox"]')].forEach(ch=>{
            const key = ch.id ? ("#"+ch.id) : ("[value='"+ch.value+"']");
            if (map.has(key)) ch.checked = !!map.get(key);
          });
        }
        if (typeof p.other === "string") $("otherInput").value = p.other;

        if (p.dice && Array.isArray(p.dice) && p.dice.length === 2){
          state.dice = p.dice;
          setDiceFace($("dice1"), p.dice[0]);
          setDiceFace($("dice2"), p.dice[1]);
        } else {
          setDiceFace($("dice1"), 6);
          setDiceFace($("dice2"), 6);
        }

        if (p.designBrief){
          state.designBrief = p.designBrief;
          state.hasDesign = true;
          $("d_company").textContent = p.designBrief.company;
          $("d_pos").textContent = p.designBrief.pos;
          $("d_color").textContent = p.designBrief.color;
          $("d_product").textContent = p.designBrief.product;
          $("d_problem").textContent = p.designBrief.problem;
          $("designHint").textContent = "джекпот: ТЗ готово";
        }

        if (p.marketingBrief){
          state.marketingBrief = p.marketingBrief;
          state.hasMarketing = true;
          $("m_company").textContent = p.marketingBrief.company;
          $("m_pos").textContent = p.marketingBrief.pos;
          $("m_product").textContent = p.marketingBrief.product;
          $("m_problem").textContent = p.marketingBrief.problem;
          $("m_task").textContent = p.marketingBrief.task;
          $("m_goal").textContent = p.marketingBrief.goal;
          $("marketingHint").textContent = "ставка сыграла: ТЗ готово";
        }
      }catch(e){}
    }

    // Wiring events
    function wire(){
      // Cards
      ["cardM","cardD"].forEach(id=>{
        $(id).addEventListener("click", ()=>{
          const role = $(id).dataset.role;
          setRole(role);
          setStatus("принято");
          startScene();
          persist();
        }, {passive:true});
      });

      // Scene buttons
      $("btnBack").addEventListener("click", ()=>{
        setStatus("готово");
        switchScreen("screenHome");
      });

      $("btnGo").addEventListener("click", ()=>{
        if (state.role === "design"){
          setStatus("готово");
          switchScreen("screenDesign");
        } else if (state.role === "marketing"){
          setStatus("готово");
          switchScreen("screenMarketing");
        } else {
          switchScreen("screenHome");
        }
      });

      // Slot pull
      $("slotPull").addEventListener("click", ()=>{
        spinSlot();
      });

      // Dice roll (cup or dice)
      $("cupBtn").addEventListener("click", ()=>{
        rollDice();
        generateMarketingBrief();
      });
      $("diceBtn").addEventListener("click", ()=>{
        rollDice();
        generateMarketingBrief();
      });

      // Copy
      $("btnCopyDesign").addEventListener("click", async ()=>{
        const text = buildDesignCopyText();
        if (!text){ showToast("Сначала прокрутите аппарат"); return; }
        await copyToClipboard(text);
      });
      $("btnCopyMarketing").addEventListener("click", async ()=>{
        const text = buildMarketingCopyText();
        if (!text){ showToast("Сначала бросьте кости"); return; }
        await copyToClipboard(text);
      });

      // Clear
      $("btnClearDesign").addEventListener("click", clearDesign);
      $("btnClearMarketing").addEventListener("click", clearMarketing);

      // Home buttons
      $("btnHomeFromDesign").addEventListener("click", ()=>{
        setStatus("готово");
        switchScreen("screenHome");
      });
      $("btnHomeFromMarketing").addEventListener("click", ()=>{
        setStatus("готово");
        switchScreen("screenHome");
      });

      // Persist on checks changes
      $("designChecks").addEventListener("change", persist);
      $("otherInput").addEventListener("input", persist);

      // initial dice faces
      setDiceFace($("dice1"), 6);
      setDiceFace($("dice2"), 6);

      // Make "other" checkbox auto-check when user types, but not annoyingly
      $("otherInput").addEventListener("input", ()=>{
        const has = $("otherInput").value.trim().length > 0;
        if (has) $("chkOther").checked = true;
        persist();
      });
    }

    // Start
    restore();
    wire();
    setStatus("готово");

    // Optional: Telegram BackButton behavior
    (function tgBack(){
      try{
        if (!(window.Telegram && Telegram.WebApp)) return;
        const BB = Telegram.WebApp.BackButton;
        if (!BB) return;

        function updateBackButton(){
          const isHome = $("screenHome").classList.contains("active");
          if (isHome) {
            BB.hide();
          } else {
            BB.show();
          }
        }

        BB.onClick(()=>{
          if ($("screenDesign").classList.contains("active") || $("screenMarketing").classList.contains("active") || $("screenScene").classList.contains("active")){
            switchScreen("screenHome");
            setStatus("готово");
            updateBackButton();
          }
        });

        // observe screen changes
        const obs = new MutationObserver(updateBackButton);
        ["screenHome","screenScene","screenDesign","screenMarketing"].forEach(id=>{
          obs.observe($(id), {attributes:true, attributeFilter:["class"]});
        });
        updateBackButton();
      } catch(e){}
    })();
  </script>
</body>
</html>
